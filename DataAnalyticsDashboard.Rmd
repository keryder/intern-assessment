---
title: "Data Analytics Dashboard"
output: html_document
runtime: shiny
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(shiny)
library(hms)
library(DT)
```

```{r, eval = TRUE, echo = FALSE}
# reactive function so any updates to data will update the app
waterData <- reactive({
  # read_delim instead of read_csv2 so doubles are read correctly
  data <- read_delim("RawData.csv", delim = ";")
  # create new columns for dates and times
  data<- mutate(data, Date = substring(Timestamp, 1, 10))
  # converting to hms format, format specified to avoid lossy conversions
  data<- mutate(data, Time = hms::as.hms(format(Timestamp, "%H:%M:%S")))
  # create vector with last 3 days
  recent <- data%>%
    pull(Date)%>%
    unique()%>%
    tail(5)
  # filter data to only include last 10 days
  data%>%
    filter(Date %in% recent)
})
```

```{r, echo = FALSE}
# reactive function for generating plot
renderPlot({
  data <- waterData() #calling waterData for most recent data
  ggplot(data, aes(x = Timestamp, y = WaterLevel)) +
    geom_point()
})
```

```{r, echo = FALSE}
# gets all data taken from current day
getDataToday <- reactive({
  data <- waterData()
  data <- filter(data, Date == data$Date[nrow(data)])
  data
})
# assigning values to variables for display boxes
getRuntime <- renderText({
  data <- waterData()
  runtime <- 0
  for(i in nrow(data):2) {
    if(data$WaterLevel[i] - data$WaterLevel[i-1] > 1) {
      runtime = runtime + data$Time[i] - data$Time[i-1]
    }
    if(data$WaterLevel[i] - data$WaterLevel[i-1] < 0) {
      break
    }
  }
  # converting runtime format
  hours <- floor(runtime / 3600)
  runtime = runtime - (hours * 3600)
  minutes = round(runtime / 60)
  runtime = runtime - (minutes * 60)
  if(hours == 0) {
    paste(minutes, "mins")
  }
  else {
    paste(hours,"hrs",minutes,"mins")
  }
})
getWaterLevel <- renderText({
  data <- getDataToday()
  waterLevel <- data$WaterLevel[nrow(data)]
  waterLevel
})
getCycles <- renderText({
  data <- getDataToday()
  cycles <- 5
  cycles
})
```

<div style= "display: flex; gap: 20px">
  <div style="border: 3px solid #ccc; padding: 3px; flex: 1;">
### Runtime: `r getRuntime`
  </div>
  <div style="border: 3px solid #ccc; padding: 3px; flex: 1;">
### Current Water Level: `r getWaterLevel` ft
  </div>
  <div style="border: 3px solid #ccc; padding: 3px; flex: 1;">
### Cycles Today: `r getCycles`
  </div>
</div>
```{r, echo = FALSE}
# Basic statistics
getAverage <- renderText({
  data <- waterData()
  mean(data$WaterLevel)
})
getMin <- renderText({
  data <- waterData()
  min(data$WaterLevel)
})
getMax <- renderText({
  data <- waterData()
  max(data$WaterLevel)
})
```
### Overall Water Level

<div style= "display: flex; gap: 20px">
  <div style="border: 3px solid #ccc; padding: 3px; flex: 1;">
### Average: `r getAverage` ft
  </div>
  <div style="border: 3px solid #ccc; padding: 3px; flex: 1;">
### Min: `r getMin` ft
  </div>
  <div style="border: 3px solid #ccc; padding: 3px; flex: 1;">
### Max: `r getMax` ft
  </div>
</div>

